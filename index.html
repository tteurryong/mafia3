<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‹±ê¸€ë§ˆí”¼ì•„</title>
<style>
:root{--bg:#0f0f12;--card:#1b1b1f;--muted:#9aa0a6;--alive:#28a745;--dead:#6c757d;}
*{box-sizing:border-box}
body{margin:0;font-family:"Malgun Gothic",system-ui,Arial;background:var(--bg);color:#eee;padding:18px;display:flex;justify-content:center}
#wrap{width:100%;max-width:1000px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
#scoreboard{position:fixed;right:16px;top:16px;background:var(--card);padding:10px;border-radius:8px;min-width:200px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
#scoreboard h3{margin:0 0 6px 0;font-size:14px}
#game{margin-top:12px}
#controls{background:var(--card);padding:12px;border-radius:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,button,input{background:#2a2a2f;color:#eee;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
button:hover,select:hover{filter:brightness(1.08)}
#main{display:flex;gap:12px;margin-top:12px}
#left{flex:1}
#messages{
  background:linear-gradient(180deg,#151519,#101014);
  padding:12px;border-radius:8px;height:320px;overflow:auto;
  white-space:pre-wrap;font-size:14px;
  display:block;
  font-family:ui-monospace,Consolas,monospace;
}
#players{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
.playerCard{display:flex;align-items:center;gap:8px;background:#26262a;padding:8px;border-radius:8px;min-width:140px}
.avatar{width:24px;height:24px;background:#222;border-radius:4px;image-rendering:pixelated}
.playerInfo{font-size:14px}
.badge{font-size:12px;padding:3px 6px;border-radius:999px;background:#333;color:#ddd;margin-left:6px}
.dead{background:var(--dead);color:#ddd;text-decoration:line-through}
.you{outline:3px solid rgba(246,200,76,0.12)}
#right{width:320px}
#inputSection{margin-top:12px;background:var(--card);padding:10px;border-radius:8px;min-height:140px}
.small{font-size:13px;color:var(--muted)}
#reveal{background:linear-gradient(90deg,#262626,#1a1a1a);padding:10px;border-radius:8px;margin-top:10px;display:none}
.footerNote{margin-top:8px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>ì‹±ê¸€ë§ˆí”¼ì•„</h1>
    <div class="small">ì˜ì‚¬: ìê¸° ì¹˜ë£Œ ê°€ëŠ¥ Â· ê²½ì°° ì¡°ì‚¬ ì¦‰ì‹œ ê³µê°œ Â· <strong>ìŠ¤íŒŒì´ ì •ë³´ëŠ” ë§ˆí”¼ì•„ë§Œ ì—´ëŒ</strong> Â· ë¡œê·¸ ëˆ„ì (1ì´ˆ)</div>
  </header>

  <div id="scoreboard">
    <h3>ì ìˆ˜íŒ</h3>
    <div id="scoreList">-</div>
  </div>

  <div id="game">
    <div id="controls">
      ì°¸ê°€ ì¸ì›:
      <select id="playerCount"></select>
      <button id="startBtn">ê²Œì„ ì‹œì‘</button>
      <button id="quickBtn">ë¹ ë¥¸ì‹œì‘(8ëª…)</button>
      <button id="resetScoreBtn" title="ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì ìˆ˜ ì´ˆê¸°í™”">ì ìˆ˜ ì´ˆê¸°í™”</button>
      <div class="small">ë‹¹ì‹ ì€ í•­ìƒ 1ë²ˆ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤.</div>
    </div>

    <div id="main">
      <div id="left">
        <div id="messages">(ë¡œê·¸ê°€ ëˆ„ì ë˜ë©° 1ì´ˆ ê°„ê²©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤)</div>
        <div id="players"></div>
        <div id="inputSection"></div>
      </div>

      <div id="right">
        <div id="reveal"><strong>ê²Œì„ ê²°ê³¼ â€” ì—­í•  ê³µê°œ</strong><div id="revealList"></div></div>
        <div class="footerNote">ë‹¤ì‹œ ì‹œì‘ ì‹œ ìš°ì¸¡ ê³µê°œ ì •ë³´ëŠ” ìë™ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- ì„¸íŒ… & ìœ í‹¸ ---------- */
const playerCountSelect = document.getElementById('playerCount');
for(let i=5;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i+'ëª…'; playerCountSelect.appendChild(o); }
const startBtn = document.getElementById('startBtn');
const quickBtn = document.getElementById('quickBtn');
const resetScoreBtn = document.getElementById('resetScoreBtn');
const messages = document.getElementById('messages');
const playersDiv = document.getElementById('players');
const inputSection = document.getElementById('inputSection');
const revealBox = document.getElementById('reveal');
const revealList = document.getElementById('revealList');
const scoreList = document.getElementById('scoreList');

let scores = {};
const SCORE_KEY = 'singlemafia_scores_v4';
function loadScores(){ try{ const s=localStorage.getItem(SCORE_KEY); if(s) scores=JSON.parse(s); }catch(e){} }
function saveScores(){ try{ localStorage.setItem(SCORE_KEY, JSON.stringify(scores)); }catch(e){} }
function ensureScores(n){ for(let i=0;i<n;i++) if(scores[i]===undefined) scores[i]=0; renderScores(); }
function renderScores(){ const ids=Object.keys(scores).map(x=>parseInt(x)).sort((a,b)=>a-b); let html=''; ids.forEach(id=> html+=`í”Œë ˆì´ì–´ ${id+1}: ${scores[id]}ì <br/>`); scoreList.innerHTML = html || '-'; }
resetScoreBtn.onclick = ()=>{ if(confirm('ì €ì¥ëœ ì ìˆ˜ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')){ scores={}; saveScores(); renderScores(); } };

loadScores(); renderScores();

/* ë©”ì‹œì§€ í: ëˆ„ì  í‘œì‹œ + 1ì´ˆ ê°„ê²© + ìë™ ìŠ¤í¬ë¡¤ */
let _msgQueue = [];
let _msgTimer = null;
function _processMsgQueue(){
  if(_msgQueue.length === 0){
    _msgTimer = null;
    return;
  }
  const line = _msgQueue.shift();
  messages.textContent += (messages.textContent ? '\n' : '') + line;
  messages.scrollTop = messages.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
  _msgTimer = setTimeout(_processMsgQueue, 1000); // 1ì´ˆ ê°„ê²©
}
function logLine(text, clear=false){
  if(clear){
    _msgQueue = [];
    if(_msgTimer){ clearTimeout(_msgTimer); _msgTimer=null; }
    messages.textContent = ''; // ì „ì²´ ë¡œê·¸ ì´ˆê¸°í™”
  }
  _msgQueue.push(String(text));
  if(!_msgTimer) _processMsgQueue();
}

/* ì‘ì€ ìœ í‹¸ */
function mkBtn(lbl, cb){ const b=document.createElement('button'); b.textContent=lbl; b.onclick=cb; return b; }
function pickRandom(arr){ return arr.length? arr[Math.floor(Math.random()*arr.length)] : null; }

/* ---------- ì—­í• /íŒ€/ë°°ë¶„ ---------- */
const TEAM = { MAFIA:'mafia', TOWN:'town', NEUTRAL:'neutral' };
const ROLES = {
  ë§ˆí”¼ì•„:{team:TEAM.MAFIA},
  ìŠ¤íŒŒì´:{team:TEAM.MAFIA},     // ì§€ì›ì—­ (í›ˆë ¨ì‚¬ ì‚­ì œë¨)
  ê²½ì°°:{team:TEAM.TOWN},
  ì˜ì‚¬:{team:TEAM.TOWN},
  ê°„í˜¸ì‚¬:{team:TEAM.TOWN},
  íŒì‚¬:{team:TEAM.TOWN},
  ì •ì¹˜ì¸:{team:TEAM.TOWN},
  ê¸°ì:{team:TEAM.TOWN},
  êµ°ì¸:{team:TEAM.TOWN},
  ë¬´ë‹¹:{team:TEAM.TOWN},
  íƒì •:{team:TEAM.TOWN},
  í…ŒëŸ¬ë²”:{team:TEAM.NEUTRAL}
};
const SUPPORT_POOL = ['ìŠ¤íŒŒì´']; // í›ˆë ¨ì‚¬ ì œê±°
const SPECIAL_POOL = ['íŒì‚¬','ì •ì¹˜ì¸','ê¸°ì','êµ°ì¸','ë¬´ë‹¹','íƒì •','ê°„í˜¸ì‚¬','í…ŒëŸ¬ë²”'];

function buildRolesByRule(n){
  let mafiaCore=1, support=0, police=1, doctor=1;
  if(n<=5){ mafiaCore=1; support=0; police=1; doctor=1; }
  else if(n<=7){ mafiaCore=1; support=1; police=1; doctor=1; }
  else if(n===8){ mafiaCore=2; support=1; police=1; doctor=2; }
  else if(n>=9 && n<=11){ mafiaCore=2; support=1; police=1; doctor=2; }
  else { mafiaCore=3; support=1; police=1; doctor=2; }
  const roles=[];
  for(let i=0;i<mafiaCore;i++) roles.push('ë§ˆí”¼ì•„');
  if(support) roles.push('ìŠ¤íŒŒì´');
  for(let i=0;i<police;i++) roles.push('ê²½ì°°');
  for(let i=0;i<doctor;i++) roles.push('ì˜ì‚¬');
  const pool=[...SPECIAL_POOL];
  while(roles.length<n && pool.length){ const idx=Math.floor(Math.random()*pool.length); roles.push(pool.splice(idx,1)[0]); }
  while(roles.length<n){ roles.push(SPECIAL_POOL[Math.floor(Math.random()*SPECIAL_POOL.length)]); }
  for(let i=roles.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [roles[i],roles[j]]=[roles[j],roles[i]]; }
  return roles;
}

/* ---------- ê²Œì„ ìƒíƒœ ---------- */
let game = null;
function alivePlayers(){ return game.players.filter(p=>p.alive); }
function teamOf(p){ return ROLES[p.role].team; }

/* avatar ê·¸ë¦¬ê¸° (ê°„ë‹¨) */
function drawAvatar(container, seed, role, alive){
  const size=8, scale=3, cv=document.createElement('canvas');
  cv.width=size; cv.height=size; cv.style.width=(size*scale)+'px'; cv.style.height=(size*scale)+'px'; cv.className='avatar';
  const ctx = cv.getContext('2d');
  function rnd(n){ const x=Math.sin(seed*1234 + n*2654435761) * 10000; return Math.abs(x%1); }
  const base = Math.floor(rnd(1)*360);
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){
    const v = rnd(x*size+y) > 0.5;
    let color = '#222';
    if(v){
      if(role==='ë§ˆí”¼ì•„' || role==='ìŠ¤íŒŒì´') color = `hsl(${(base+0)%360} 70% 50%)`;
      else if(role==='ê²½ì°°') color = `hsl(${(base+120)%360} 70% 50%)`;
      else if(role==='ì˜ì‚¬' || role==='ê°„í˜¸ì‚¬') color = `hsl(${(base+60)%360} 70% 50%)`;
      else color = `hsl(${(base+200)%360} 60% 45%)`;
    } else color = '#0b0b0b';
    ctx.fillStyle = color; ctx.fillRect(x,y,1,1);
  }
  if(!alive){ ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(0,0,size,size); ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='6px monospace'; ctx.fillText('X',2,6); }
  container.appendChild(cv);
}

function renderPlayers(){
  playersDiv.innerHTML = '';
  game.players.forEach(p=>{
    const card = document.createElement('div'); card.className='playerCard';
    const avwrap=document.createElement('div'); avwrap.style.width='36px';
    drawAvatar(avwrap, p.id+7, p.role, p.alive);
    const info=document.createElement('div'); info.className='playerInfo';
    const title=document.createElement('div'); title.textContent = (p.id+1) + (p.id===0? ' (ë‹¹ì‹ )':'');
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent = p.alive ? 'ìƒì¡´' : 'ì‚¬ë§';
    title.appendChild(badge);
    const sub=document.createElement('div'); sub.className='small'; sub.style.color='#bfbfbf';
    sub.textContent = '';
    info.appendChild(title); info.appendChild(sub);
    if(!p.alive) card.classList.add('dead');
    if(p.id===0) card.classList.add('you');
    card.appendChild(avwrap); card.appendChild(info);
    playersDiv.appendChild(card);
  });
}

/* ---------- ì‹œì‘ ---------- */
startBtn.onclick = ()=> startGame(parseInt(playerCountSelect.value));
quickBtn.onclick = ()=>{ playerCountSelect.value = 8; startGame(8); };

function startGame(n){
  // â¬‡ï¸ ë‹¤ì‹œ ì‹œì‘ ì‹œ ê³µê°œ ì •ë³´ ì´ˆê¸°í™” (ìš”ì²­ ë°˜ì˜)
  revealBox.style.display = 'none';
  revealList.innerHTML = '';

  const roles = buildRolesByRule(n);
  game = {
    players: roles.map((r,i)=>({ id:i, role:r, alive:true, flags:{ blockedUntilDay:0, soldierArmor:(r==='êµ°ì¸'), usedSoldierShot:false }})),
    day:0, night:0, phase:'night',
    spyKnown:[],             // (ì‚¬ìš©ì UIìš©) ìŠ¤íŒŒì´ ê°œì¸ ì§€ì‹
    mafiaIntel:new Map(),     // (AI/ë§ˆí”¼ì•„ ê³µìœ ) ìŠ¤íŒŒì´ ì •ë³´ ì§‘í•©: id -> {role, team}
    nightActs:{},
    journalistReveal:null, detectiveMsg:null,
    suspicion:{}, lastVotes:{}, soldierShotAvailable:false,
    policeInvestigated: new Set()
  };
  ensureScores(n);
  renderPlayers();

  // ê²½ì°° ìœ„ì¹˜ ê³µê°œ(ì²«ë‚ ë¶€í„°)
  const police = game.players.find(p=>p.role==='ê²½ì°°');
  if(police) logLine(`(ê³µì§€) ê²½ì°°ì€ ${police.id+1}ë²ˆ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤.`, true);
  else logLine('(ê³µì§€) ì´ë²ˆ ê²Œì„ì— ê²½ì°° ì—­í• ì´ ì—†ìŠµë‹ˆë‹¤.', true);

  // ë§ˆí”¼ì•„ ë™ë£Œ ì•Œë ¤ì£¼ê¸°(í”Œë ˆì´ì–´ê°€ ë§ˆí”¼ì•„ì´ë©´)
  const myRole = game.players[0].role;
  if(myRole === 'ë§ˆí”¼ì•„' || myRole === 'ìŠ¤íŒŒì´'){
    const mafiaIds = game.players.filter(p=> teamOf(p)===TEAM.MAFIA && p.id!==0).map(p=>p.id);
    logLine(mafiaIds.length? `(ë¹„ë°€) ë‹¹ì‹ ì˜ ë§ˆí”¼ì•„ ë™ë£Œ: ${mafiaIds.map(x=>x+1).join(', ')}ë²ˆ` : '(ë¹„ë°€) ë‹¹ì‹ ì€ ìœ ì¼í•œ ë§ˆí”¼ì•„ í¸ì…ë‹ˆë‹¤.');
  }

  setTimeout(()=> nextPhase('night'), 700);
}

function nextPhase(phase){
  game.phase = phase;
  inputSection.innerHTML = '';
  if(phase==='night') nightPhase();
  else if(phase==='day') dayPhase();
  else if(phase==='end') endPhase();
}

/* ---------- NIGHT ---------- */
function canUseAbility(p){ if(!p.alive) return false; if(game.day < p.flags.blockedUntilDay) return false; return true; }
function nurseActing(){ const docAlive = game.players.some(p=>p.role==='ì˜ì‚¬' && p.alive); const nurse = game.players.find(p=>p.role==='ê°„í˜¸ì‚¬' && p.alive); return nurse && !docAlive; }
function isSpySoloActive(){
  // ë§ˆí”¼ì•„ ë³¸ëŒ€(ë§ˆí”¼ì•„) ìƒì¡´ì ìˆ˜
  const coreMafiaAlive = alivePlayers().filter(p=> p.role==='ë§ˆí”¼ì•„').length;
  // ìŠ¤íŒŒì´ê°€ ì‚´ì•„ ìˆê³  ë§ˆí”¼ì•„ ë³¸ëŒ€ê°€ ì—†ìœ¼ë©´ ë‹¨ë… ê³µê²© í—ˆìš©
  return alivePlayers().some(p=>p.role==='ìŠ¤íŒŒì´') && coreMafiaAlive===0;
}

function nightPhase(){
  game.night++; game.nightActs = {}; game.journalistReveal = null; game.detectiveMsg = null;
  logLine(`\nğŸŒ™ ë°¤ ${game.night} ì‹œì‘`);
  renderPlayers();

  if(!game.players[0].alive){ logLine('ë‹¹ì‹ ì€ ì‚¬ë§í•´ ë°¤ í–‰ë™ ì—†ìŒ.'); return setTimeout(aiNightActions,700); }

  const me = game.players[0];
  const alive = alivePlayers();

  const addButtons=(label,cb,filterFn=()=>true)=>{
    const wrap=document.createElement('div'); wrap.innerHTML = `<div class="small">${label}</div>`;
    alive.filter(x=>x.id!==me.id && filterFn(x)).forEach(t=>{
      const b = mkBtn((t.id+1)+'ë²ˆ', ()=>{ cb(t.id); inputSection.innerHTML=''; logLine(`${me.role}ì´ ${t.id+1}ë²ˆì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`); setTimeout(aiNightActions,400); });
      wrap.appendChild(b);
    });
    inputSection.appendChild(wrap);
  };

  if(me.role==='ë§ˆí”¼ì•„'){
    logLine('ë‹¹ì‹ (ë§ˆí”¼ì•„)ì€ ê³µê²© ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.');
    addButtons('ê³µê²© ëŒ€ìƒ', id => game.nightActs.mafiaKill = id, p=> teamOf(p)!==TEAM.MAFIA);
  } else if(me.role==='ìŠ¤íŒŒì´'){
    logLine('ë‹¹ì‹ (ìŠ¤íŒŒì´)ì€ ì§ì—… íƒì§€ ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.');
    addButtons('íƒì§€ ëŒ€ìƒ', id => game.nightActs.spyPeek = id);
    if(isSpySoloActive()) addButtons('ìŠ¤íŒŒì´ ë‹¨ë… ê³µê²©', id => game.nightActs.spyKill = id);
  } else if(me.role==='ì˜ì‚¬' || (me.role==='ê°„í˜¸ì‚¬' && nurseActing())){
    logLine(`ë‹¹ì‹ (${me.role})ì€ ì¹˜ë£Œ ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”. (ìê¸° ìì‹  í¬í•¨)`);
    const wrap=document.createElement('div'); wrap.innerHTML='<div class="small">ì¹˜ë£Œ ëŒ€ìƒ</div>';
    alive.forEach(t=>{
      const b = mkBtn((t.id+1)+'ë²ˆ', ()=>{ game.nightActs.heal = t.id; inputSection.innerHTML=''; logLine(`${me.role}ì´ ${t.id+1}ë²ˆì„ ì¹˜ë£Œ ëŒ€ìƒìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`); setTimeout(aiNightActions,400); });
      wrap.appendChild(b);
    });
    inputSection.appendChild(wrap);
  } else if(me.role==='ê²½ì°°'){
    logLine('ë‹¹ì‹ (ê²½ì°°)ì€ ì¡°ì‚¬ ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.');
    addButtons('ì¡°ì‚¬ ëŒ€ìƒ', id => { game.nightActs.policeCheck = id; });
  } else if(me.role==='íƒì •'){
    logLine('ë‹¹ì‹ (íƒì •)ì€ ì¶”ì  ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.');
    addButtons('ì¶”ì  ëŒ€ìƒ', id => { game.nightActs.detectiveTrack = id; });
  } else if(me.role==='êµ°ì¸' && game.soldierShotAvailable && !me.flags.usedSoldierShot){
    logLine('ë‹¹ì‹ (êµ°ì¸)ì€ 1íšŒ ì‚¬ê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    addButtons('ì‚¬ê²© ëŒ€ìƒ', id => { game.nightActs.soldierShot = id; me.flags.usedSoldierShot=true; game.soldierShotAvailable=false; });
  } else {
    logLine(`ë‹¹ì‹ (${me.role})ì€ ë°¤ í–‰ë™ ì—†ìŒ.`);
    setTimeout(aiNightActions,600);
  }
}

function aiNightActions(){
  const alive = alivePlayers();
  const A = game.nightActs;

  // ë§ˆí”¼ì•„ ë©”ì¸ ê³µê²©
  if(A.mafiaKill == null){
    const mafiaGroup = alive.filter(p=> p.role==='ë§ˆí”¼ì•„');
    if(mafiaGroup.length){
      let best=null, bestScore=-1e9;
      alive.filter(p=> teamOf(p)!==TEAM.MAFIA).forEach(c=>{
        let s = 0;
        if(c.role==='ê²½ì°°') s+=60;
        if(c.role==='ì˜ì‚¬' || c.role==='ê°„í˜¸ì‚¬') s+=40;
        if(c.role==='íŒì‚¬') s+=30;
        s += (game.suspicion[c.id]||0);
        s += Math.random()*6;
        // ìŠ¤íŒŒì´ ì •ë³´ ë°˜ì˜ (ë§ˆí”¼ì•„ê°€ ì•Œê³  ìˆëŠ” ì•ˆì „/ìœ„í—˜ ëŒ€ìƒ)
        if(game.mafiaIntel.has(c.id)){
          const info = game.mafiaIntel.get(c.id);
          if(info.team===TEAM.MAFIA) s -= 999; // íŒ€í‚¬ ë°©ì§€
          if(info.team===TEAM.TOWN) s += 10;   // í™•ì‹¤í•œ íƒ€ìš´ì´ë©´ ê°€ì‚°
        }
        if(s>bestScore){ bestScore=s; best=c; }
      });
      if(best) A.mafiaKill = best.id;
    } else {
      // ë§ˆí”¼ì•„ ë³¸ëŒ€ê°€ ì—†ìœ¼ë©´ ìŠ¤íŒŒì´ ë‹¨ë… ê³µê²© ê°€ëŠ¥
      if(isSpySoloActive() && A.spyKill==null){
        const t = pickRandom(alive.filter(x=> x.role!=='ìŠ¤íŒŒì´'));
        if(t) A.spyKill = t.id;
      }
    }
  }

  // ìŠ¤íŒŒì´ íƒì§€ (AI ìŠ¤íŒŒì´)
  if(A.spyPeek==null){
    const spyAi = alive.find(p=>p.role==='ìŠ¤íŒŒì´' && p.id!==0);
    if(spyAi && canUseAbility(spyAi)){
      const t = pickRandom(alive.filter(x=> x.id!==spyAi.id));
      if(t) A.spyPeek = t.id;
    }
  }

  // ì˜ì‚¬/ê°„í˜¸ì‚¬ ì¹˜ë£Œ
  if(A.heal==null){
    const docs = alive.filter(p=> (p.role==='ì˜ì‚¬' || (p.role==='ê°„í˜¸ì‚¬' && nurseActing())) && p.id!==0);
    if(docs.length){
      let target = alive.find(x=> x.role==='ê²½ì°°') || docs[0];
      if(target) A.heal = target.id;
    }
  }

  // ê²½ì°° ì¡°ì‚¬
  if(A.policeCheck==null){
    const cops = alive.filter(p=> p.role==='ê²½ì°°' && p.id!==0);
    if(cops.length){
      const cp = cops[0];
      const t = pickRandom(alive.filter(x=> x.id!==cp.id));
      if(t) A.policeCheck = t.id;
    }
  }

  // ê¸°ì ëª©í‘œ(ì§ìˆ˜ë°¤)
  if(A.journalistTarget==null){
    const jr = alive.find(p=>p.role==='ê¸°ì' && p.id!==0);
    if(jr && (game.night%2===0)) {
      const t = pickRandom(alive.filter(x=> x.id!==jr.id));
      if(t) A.journalistTarget = t.id;
    }
  }

  // íƒì • ì¶”ì 
  if(A.detectiveTrack==null){
    const dt = alive.find(p=> p.role==='íƒì •' && p.id!==0);
    if(dt){
      const t = pickRandom(alive.filter(x=> x.id!==dt.id));
      if(t) A.detectiveTrack = t.id;
    }
  }

  setTimeout(resolveNight, 700);
}

/* ---------- ë°¤ í•´ê²° ---------- */
function resolveNight(){
  const A = game.nightActs;
  const kills = new Set();

  // ìŠ¤íŒŒì´ íƒì§€ ê²°ê³¼ â€” **ë¹„ê³µê°œ ì²˜ë¦¬ (ë§ˆí”¼ì•„ ì§„ì˜ë§Œ ê³µìœ )**
  if(A.spyPeek!=null){
    const t = game.players[A.spyPeek];
    if(t){
      const info = { id:t.id, role:t.role, team: teamOf(t) };
      game.mafiaIntel.set(t.id, {role:t.role, team:info.team}); // ë§ˆí”¼ì•„ ì „ì²´ê°€ ê³µìœ í•˜ëŠ” ì •ë³´ ì €ì¥
      if(0 === 0){ // í”Œë ˆì´ì–´ê°€ ë§ˆí”¼ì•„ í¸ì´ë©´ ë¹„ë°€ ë¡œê·¸ë¡œ ë³´ì—¬ì¤€ë‹¤
        const me = game.players[0];
        if(me.role==='ìŠ¤íŒŒì´' || me.role==='ë§ˆí”¼ì•„'){
          logLine(`(ë¹„ë°€/ìŠ¤íŒŒì´) ${t.id+1}ë²ˆ: ${info.role} / íŒ€=${info.team}`);
        }
      }
      // íƒ€ìš´ì—ê²ŒëŠ” ì•„ë¬´ê²ƒë„ ê³µê°œí•˜ì§€ ì•ŠìŒ
      // game.spyKnownëŠ” í”Œë ˆì´ì–´ê°€ ìŠ¤íŒŒì´ì¼ ë•Œë§Œ ê°œì¸ ê¸°ë¡ ìš©ë„ë¡œ ì‚¬ìš©
      if(game.players[0].role==='ìŠ¤íŒŒì´') game.spyKnown.push(info);
    }
  }

  // ê²½ì°° ì¡°ì‚¬ ì¦‰ì‹œ ê³µê°œ(ì „ì²´ ê³µì§€ â€” ê¸°ì¡´ ê·œì¹™ ìœ ì§€)
  if(A.policeCheck!=null){
    const t = game.players[A.policeCheck];
    if(t){
      const isMafia = (teamOf(t)===TEAM.MAFIA);
      logLine(`ê²½ì°° ì¡°ì‚¬ ê²°ê³¼: ${t.id+1}ë²ˆì€ ${isMafia? 'ë§ˆí”¼ì•„ì…ë‹ˆë‹¤!':'ë§ˆí”¼ì•„ê°€ ì•„ë‹™ë‹ˆë‹¤.'}`);
      game.policeInvestigated.add(t.id);
      game.suspicion[t.id] = (game.suspicion[t.id]||0) + (isMafia? 50 : -20);
    }
  }

  // êµ°ì¸ ì‚¬ê²©
  if(A.soldierShot!=null){
    const t = game.players[A.soldierShot];
    if(t && t.alive){ kills.add(t.id); logLine(`êµ°ì¸ì´ ${t.id+1}ë²ˆì„ ì‚¬ê²©í–ˆìŠµë‹ˆë‹¤.`); }
  }

  // ë§ˆí”¼ì•„/ìŠ¤íŒŒì´ ê³µê²©ê²°ì •
  let victim = null;
  if(A.mafiaKill!=null) victim = game.players[A.mafiaKill];
  else if(A.spyKill!=null) victim = game.players[A.spyKill];

  if(victim){
    if(A.heal === victim.id){
      logLine(`${victim.id+1}ë²ˆì€ ì¹˜ë£Œë¡œ ìƒì¡´í–ˆìŠµë‹ˆë‹¤.`);
    } else if(victim.role==='êµ°ì¸' && victim.flags.soldierArmor){
      victim.flags.soldierArmor = false;
      logLine(`êµ°ì¸(${victim.id+1})ì´ ë°©íƒ„ìœ¼ë¡œ ìƒì¡´í–ˆìŠµë‹ˆë‹¤.`);
    } else {
      if(victim.role==='í…ŒëŸ¬ë²”'){
        const mafiaAlive = alivePlayers().filter(p=> teamOf(p)===TEAM.MAFIA);
        if(mafiaAlive.length){
          const m = pickRandom(mafiaAlive);
          if(m) { kills.add(m.id); logLine(`í…ŒëŸ¬ë²”(${victim.id+1}) ìí­! ë§ˆí”¼ì•„(${m.id+1})ê°€ í•¨ê»˜ ì‚¬ë§.`); }
        }
      }
      kills.add(victim.id);
      logLine(`${victim.id+1}ë²ˆì´ ë°¤ì— ì‚¬ë§í–ˆìŠµë‹ˆë‹¤.`);
    }
  } else {
    logLine('ë°¤ ê³µê²©ì´ ì—†ì—ˆìŠµë‹ˆë‹¤.');
  }

  // ì‚¬ë§ ì ìš©
  kills.forEach(id => {
    if(game.players[id] && game.players[id].alive) {
      game.players[id].alive = false;
      if(!game.firstDeathRole) game.firstDeathRole = game.players[id].role;
    }
  });

  // ë¬´ë‹¹ ë³€ì´(ì²« ì‚¬ë§ ì—­í•  ê³„ìŠ¹)
  if(game.firstDeathRole){
    const shaman = game.players.find(p=> p.role==='ë¬´ë‹¹' && p.alive);
    if(shaman && !shaman.flags.morphed){
      shaman.role = game.firstDeathRole;
      shaman.flags.morphed = true;
      logLine(`ë¬´ë‹¹ì´ ì²« ì‚¬ë§ìì˜ ì§ì—…(${game.firstDeathRole})ì„ ê³„ìŠ¹í–ˆìŠµë‹ˆë‹¤.`);
    }
  }

  // ê²½ì°° ì‚¬ë§ â†’ êµ°ì¸ ì‚¬ê²© í—ˆìš©
  const anyPolice = game.players.some(p=> p.role==='ê²½ì°°');
  const policeAlive = alivePlayers().some(p=> p.role==='ê²½ì°°');
  if(anyPolice && !policeAlive && !game._policeWasDead){
    game.soldierShotAvailable = true;
    logLine('ê²½ì°°ì´ ëª¨ë‘ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. êµ°ì¸ì´ 1íšŒ ì‚¬ê²© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  }
  game._policeWasDead = !policeAlive;

  // ê¸°ì ê³µê°œ(ìˆë‹¤ë©´)
  if(A.journalistTarget!=null){
    const t = game.players[A.journalistTarget];
    if(t){
      game.journalistReveal = `ê¸°ì: ${t.id+1}ë²ˆì€ ${t.role}ì…ë‹ˆë‹¤.`;
      logLine(game.journalistReveal);
      if(teamOf(t)===TEAM.MAFIA) game.suspicion[t.id] = (game.suspicion[t.id]||0) + 35;
      else game.suspicion[t.id] = (game.suspicion[t.id]||0) - 8;
    }
  }

  // íƒì • ê³µê°œ(ìœ ë¬´ ì¶”ì ) â€” ê°„ë‹¨ ì²˜ë¦¬
  if(A.detectiveTrack!=null){
    const tracked = A.detectiveTrack;
    const used = game._usedByThisNight && game._usedByThisNight.has(tracked);
    game.detectiveMsg = used ? `íƒì •: ${tracked+1}ë²ˆì€ ì „ë‚  ë°¤ ëŠ¥ë ¥ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.` : `íƒì •: ${tracked+1}ë²ˆì€ ì „ë‚  ë°¤ ëŠ¥ë ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
    logLine(game.detectiveMsg);
    if(used) game.suspicion[tracked] = (game.suspicion[tracked]||0) + 6;
  }

  renderPlayers();

  if(!game.players[0].alive) logLine('ë‹¹ì‹ ì´ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. ê²Œì„ ìë™ ì§„í–‰ë©ë‹ˆë‹¤.');

  if(checkWin()) return setTimeout(()=> nextPhase('end'), 900);
  setTimeout(()=> nextPhase('day'), 900);
}

/* ---------- DAY ---------- */
function dayPhase(){
  game.day++;
  logLine(`\nâ˜€ ë‚® ${game.day} ì‹œì‘`);
  renderPlayers();

  const alive = alivePlayers();
  const judge = alive.find(p=> p.role==='íŒì‚¬');
  const playerAlive = game.players[0].alive;

  if(judge){
    logLine('íŒì‚¬ê°€ ìƒì¡´í•©ë‹ˆë‹¤ â€” ì¼ë°˜ íˆ¬í‘œëŠ” ë¬´ì‹œë˜ê³  íŒì‚¬ê°€ ì²˜í˜•ìë¥¼ ì§€ì •í•©ë‹ˆë‹¤. (íŒì‚¬/ì •ì¹˜ì¸ì€ íˆ¬í‘œ ë©´ì—­)');
    if(playerAlive && game.players[0].role==='íŒì‚¬'){
      inputSection.innerHTML='';
      alive.filter(x=> x.id!==0).forEach(t=> inputSection.appendChild(mkBtn(`${t.id+1}ë²ˆ ì²˜í˜•`, ()=>{ executeByJudge(t.id); })));
    } else {
      setTimeout(()=> aiJudgeExecute(judge.id), 900);
    }
    return;
  }

  // ì¼ë°˜íˆ¬í‘œ
  if(!playerAlive){
    logLine('ë‹¹ì‹ ì€ ì£½ì–´ íˆ¬í‘œ ë¶ˆê°€. AIê°€ íˆ¬í‘œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
    setTimeout(()=> aiVoteResolve(null), 900);
  } else {
    inputSection.innerHTML = '<div class="small">ëˆ„êµ¬ë¥¼ ì²˜í˜•í• ê¹Œìš”? (ë³¸ì¸ ì œì™¸) â€” ì •ì¹˜ì¸/íŒì‚¬ëŠ” íˆ¬í‘œë¡œ ì£½ì§€ ì•ŠìŒ</div>';
    alive.filter(p=> p.id!==0).forEach(p=> inputSection.appendChild(mkBtn(`${p.id+1}ë²ˆ`, ()=>{ inputSection.innerHTML=''; aiVoteResolve(p.id); })));
  }
}

/* íŒì‚¬ ì²˜í˜• */
function executeByJudge(tid){
  const t = game.players[tid];
  if(!t || !t.alive) return;
  if(t.role==='íŒì‚¬'){ logLine('íŒì‚¬ëŠ” ìŠ¤ìŠ¤ë¡œë¥¼ ì²˜í˜•í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  t.alive=false; logLine(`íŒì‚¬ê°€ ${t.id+1}ë²ˆì„ ì²˜í˜•í–ˆìŠµë‹ˆë‹¤.`);
  if(t.role==='í…ŒëŸ¬ë²”'){
    const r = pickRandom(alivePlayers());
    if(r){ r.alive=false; logLine(`í…ŒëŸ¬ë²”(${t.id+1})ê°€ ë¬´ì‘ìœ„(${r.id+1})ë¥¼ ë™ë°˜ ì²˜í˜•í–ˆìŠµë‹ˆë‹¤.`); }
  }
  renderPlayers();
  if(checkWin()) setTimeout(()=> nextPhase('end'),800); else setTimeout(()=> nextPhase('night'),800);
}
function aiJudgeExecute(judgeId){
  const cand = alivePlayers().filter(p=> p.id!==judgeId);
  if(!cand.length) return setTimeout(()=> nextPhase('night'),600);
  const t = pickRandom(cand);
  executeByJudge(t.id);
}

/* ---------- íˆ¬í‘œ (AI) ---------- */
function candidateScoreFor(voter, target){
  if(!target.alive) return -1e9;
  if(voter.id === target.id) return -1e9;
  const immune = (target.role==='ì •ì¹˜ì¸' || target.role==='íŒì‚¬');
  let s = 0;
  if(teamOf(voter)===TEAM.MAFIA){
    s += (target.role==='ê²½ì°°')? 50 : (target.role==='ì˜ì‚¬'||target.role==='ê°„í˜¸ì‚¬')? 30 : 10;
    // ìŠ¤íŒŒì´ ì •ë³´ ë°˜ì˜
    if(game.mafiaIntel.has(target.id)){
      const info = game.mafiaIntel.get(target.id);
      if(info.team===TEAM.MAFIA) s -= 999;
      if(info.team===TEAM.TOWN) s += 10;
    }
  } else if(teamOf(voter)===TEAM.TOWN){
    s += (game.suspicion[target.id]||0);
    s += (target.role==='ë§ˆí”¼ì•„'||target.role==='ìŠ¤íŒŒì´')? 15 : 0;
  } else {
    s += (target.role==='ê²½ì°°' || target.role==='ì˜ì‚¬')? 12 : 5;
  }
  const beenVotedBy = Object.entries(game.lastVotes).filter(([voterId,tid])=> parseInt(voterId)===target.id && tid===voter.id);
  if(beenVotedBy.length) s += 4;
  if(immune) s -= 25;
  s += Math.random()*3;
  return s;
}

function aiVoteResolve(myPick){
  const votes = {};
  function addVote(id, w=1){ votes[id] = (votes[id]||0) + w; }
  const alive = alivePlayers();

  if(myPick != null){
    addVote(myPick, (game.players[0].role==='ì •ì¹˜ì¸'?2:1));
    game.lastVotes[0] = myPick;
  }

  alive.forEach(voter=>{
    if(voter.id===0) return;
    let best=null, bestS=-1e9;
    alive.forEach(target=>{
      if(target.id===voter.id) return;
      const s = candidateScoreFor(voter, target);
      if(s>bestS){ bestS=s; best=target; }
    });
    if(best) { addVote(best.id, (voter.role==='ì •ì¹˜ì¸'?2:1)); game.lastVotes[voter.id]=best.id; }
  });

  // ë§ˆí”¼ì•„ ê²°ì§‘ ì„±í–¥
  const mafiaVoters = alive.filter(p=> teamOf(p)===TEAM.MAFIA);
  if(mafiaVoters.length){
    let leader=null, max=0;
    for(const [id,c] of Object.entries(votes)){ if(c>max){ max=c; leader=parseInt(id); } }
    if(leader!=null){
      mafiaVoters.forEach(mv=>{
        if(game.lastVotes[mv.id] !== leader){
          addVote(leader, (mv.role==='ì •ì¹˜ì¸'?2:1));
        }
      });
    }
  }

  logLine('\níˆ¬í‘œ ì§‘ê³„:');
  for(const [id,c] of Object.entries(votes)) logLine(`${parseInt(id)+1}ë²ˆ: ${c}í‘œ`);

  let max=0, winners=[];
  for(const [id,c] of Object.entries(votes)){ if(c>max){ max=c; winners=[parseInt(id)]; } else if(c===max){ winners.push(parseInt(id)); } }
  if(winners.length===1){
    const t = game.players[winners[0]];
    if(t.role==='ì •ì¹˜ì¸' || t.role==='íŒì‚¬'){
      logLine(`ë‚®: ${t.role}(${t.id+1})ì€ íˆ¬í‘œë¡œ ì£½ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
    } else {
      t.alive=false;
      logLine(`ë‚®: ${t.id+1}ë²ˆì´ ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      if(t.role==='í…ŒëŸ¬ë²”'){
        const r = pickRandom(alivePlayers());
        if(r){ r.alive=false; logLine(`í…ŒëŸ¬ë²”(${t.id+1})ê°€ ë¬´ì‘ìœ„(${r.id+1})ë¥¼ ë™ë°˜ ì‚¬ë§ì‹œì¼°ìŠµë‹ˆë‹¤.`); }
      }
      const isM = (teamOf(t)===TEAM.MAFIA);
      alivePlayers().forEach(p=> { if(p.id!==t.id) game.suspicion[p.id] = (game.suspicion[p.id]||0) + (isM? -2 : 1); });
    }
  } else {
    logLine('ë‚®: ë™ì /ë¬´íš¨ë¡œ ì²˜í˜• ì—†ìŒ.');
  }

  renderPlayers();
  if(checkWin()) setTimeout(()=> nextPhase('end'),900); else setTimeout(()=> nextPhase('night'),900);
}

/* ---------- ìŠ¹ë¦¬ / ì¢…ë£Œ / ì ìˆ˜ ---------- */
function checkWin(){
  const alive = alivePlayers();
  const mafiaAlive = alive.filter(p=> teamOf(p)===TEAM.MAFIA).length;
  const townAlive = alive.filter(p=> teamOf(p)===TEAM.TOWN).length;
  if(mafiaAlive===0){ logLine('\nğŸ‰ íƒ€ìš´ ìŠ¹ë¦¬!'); applyScores('town'); return true; }
  if(mafiaAlive >= townAlive && mafiaAlive>0){ logLine('\nğŸ’€ ë§ˆí”¼ì•„ ìŠ¹ë¦¬!'); applyScores('mafia'); return true; }
  return false;
}
function applyScores(winner){
  game.players.forEach(p=>{
    if(scores[p.id]===undefined) scores[p.id]=0;
    const team = teamOf(p);
    if(team === winner) scores[p.id] += 10;
    else scores[p.id] -= 2;
  });
  renderScores(); saveScores();
}
function endPhase(){
  logLine('\n=== ê²Œì„ ì¢…ë£Œ â€” ì—­í•  ê³µê°œ ===');
  revealBox.style.display='block';
  let html = '';
  game.players.forEach(p=> html += `${p.id+1}ë²ˆ: ${p.role} (${p.alive? 'ìƒì¡´':'ì‚¬ë§'})<br/>`);
  revealList.innerHTML = html;
  inputSection.innerHTML = '<div style="text-align:center;margin-top:10px;"><button id="restart">ë‹¤ì‹œ ì‹œì‘</button></div>';
  document.getElementById('restart').onclick = ()=> {
    // ë‹¤ì‹œ ì‹œì‘ ì‹œ ê³µê°œ ì •ë³´ëŠ” startGameì—ì„œ ì´ˆê¸°í™”ë¨
    location.reload();
  };
  renderPlayers();
}
</script>
</body>
</html>
