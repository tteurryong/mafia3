<!DOCTYPE html><html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ì‹±ê¸€ë§ˆí”¼ì•„ </title>
<style>
:root{--bg:#0f0f12;--card:#1b1b1f;--muted:#9aa0a6;--accent:#f6c84c;--alive:#28a745;--dead:#6c757d;--ink:#e6e9ef}
*{box-sizing:border-box}
body{margin:0;font-family:"Malgun Gothic",system-ui,Arial;background:var(--bg);color:#eee;padding:18px;display:flex;justify-content:center}
#wrap{width:100%;max-width:1200px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
#scoreboard{position:fixed;right:16px;top:16px;background:var(--card);padding:10px;border-radius:8px;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
#scoreboard h3{margin:0 0 6px 0;font-size:14px}
#scoreboard .mini{font-size:12px;color:var(--muted);margin-bottom:6px}
#game{margin-top:12px}
#controls{background:var(--card);padding:12px;border-radius:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,button,input{background:#2a2a2f;color:#eee;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
button:hover,select:hover{filter:brightness(1.08)}
#main{display:grid;grid-template-columns:1fr 360px 320px;gap:12px;margin-top:12px}
#left{min-width:0}
#messages{background:linear-gradient(180deg,#151519,#101014);padding:12px;border-radius:8px;min-height:360px;max-height:680px;overflow:auto;white-space:pre-wrap;font-size:14px}
#players{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
.playerCard{display:flex;align-items:center;gap:8px;background:#26262a;padding:8px;border-radius:8px;min-width:160px}
.avatar{width:24px;height:24px;background:#222;border-radius:4px;image-rendering:pixelated}
.playerInfo{font-size:14px}
.badge{font-size:12px;padding:3px 6px;border-radius:999px;background:#333;color:#ddd;margin-left:6px}
.dead{background:var(--dead);color:#ddd;text-decoration:line-through}
.you{outline:3px solid rgba(246,200,76,0.12)}
#middle{min-width:0}
#inputSection{margin-top:12px;background:var(--card);padding:10px;border-radius:8px;min-height:140px}
.small{font-size:13px;color:var(--muted)}
#right{min-width:0}
#reveal{background:linear-gradient(90deg,#262626,#1a1a1a);padding:10px;border-radius:8px;margin-top:10px;display:none}
.footerNote{margin-top:8px;color:var(--muted);font-size:13px}
.warn{background:#33250a;border:1px solid #664a0e;color:#ffd98a;border-radius:8px;padding:8px;margin-bottom:8px}
.pill{display:inline-block;background:#303036;border:1px solid #45454e;border-radius:999px;padding:3px 8px;margin-right:6px;font-size:12px;color:#cbd3ff}
/* ë¹„ë°€ì°½ */
#dmPanel{background:var(--card);border-radius:8px;padding:8px;display:flex;flex-direction:column;gap:8px}
#dmHeader{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
#dmTabs{display:flex;gap:6px;flex-wrap:wrap}
.dmTab{background:#2a2a2f;border:1px solid #3a3a42;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
.dmTab.active{background:#3b3b46;border-color:#6d6d7a}
#dmLog{background:#0f1014;border:1px solid #2a2a34;min-height:220px;max-height:320px;overflow:auto;border-radius:8px;padding:8px;white-space:pre-wrap;font-size:13px}
#dmInputRow{display:flex;gap:6px}
#dmInput{flex:1}
.system{color:#9bb4ff}
.me{color:#a6e3a1}
.them{color:#f2cdcd}
.roletag{color:#ffd399}
</style>
</head>
<body>
<div id="wrap">
  <header>
    <h1>ì‹±ê¸€ë§ˆí”¼ì•„ â€” </h1>
    <div class="small">ì˜ì‹¬í‘œì‹œ ì—†ìŒ Â· ì‹ ê·œ ì§ì—…/ê·œì¹™ Â· ìŠ¤ë§ˆíŠ¸ íˆ¬í‘œ Â· ë¹„ë°€ì°½ Â· ì ìˆ˜ ëˆ„ì </div>
  </header>  <div id="scoreboard">
    <h3>ì ìˆ˜íŒ</h3>
    <div class="mini">ì„¸ì…˜+ë¸Œë¼ìš°ì € ë¡œì»¬ì— ëˆ„ì  ì €ì¥</div>
    <div id="scoreList">-</div>
  </div>  <div id="game">
    <div id="controls">
      ì°¸ê°€ ì¸ì›:
      <select id="playerCount"></select>
      <button id="startBtn">ê²Œì„ ì‹œì‘</button>
      <button id="quickBtn">ë¹ ë¥¸ì‹œì‘(8ëª…)</button>
      <button id="resetScoreBtn" title="ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì ìˆ˜ ì´ˆê¸°í™”">ì ìˆ˜ ì´ˆê¸°í™”</button>
      <div class="small">ë‹¹ì‹ ì€ í•­ìƒ 1ë²ˆ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤.</div>
    </div><div id="main">
  <div id="left">
    <div id="messages"></div>
    <div id="players"></div>
    <div id="inputSection"></div>
  </div>

  <div id="middle">
    <div id="dmPanel">
      <div id="dmHeader">
        <span class="small">ë¹„ë°€ì°½ (ê°œì¸/íŒ€ ì ‘ì„  ê³µìœ )</span>
        <div id="dmTabs"></div>
      </div>
      <div id="dmLog"></div>
      <div id="dmInputRow">
        <input id="dmInput" placeholder="ë©”ì‹œì§€ ì…ë ¥ (ë³´ë‚¼ ìˆ˜ ìˆëŠ” ë°©ì—ë§Œ ì „ì†¡ ê°€ëŠ¥)"/>
        <button id="dmSendBtn">ë³´ë‚´ê¸°</button>
      </div>
    </div>
    <div id="reveal"><strong>ê²Œì„ ê²°ê³¼ â€” ì—­í•  ê³µê°œ</strong><div id="revealList"></div></div>
  </div>

  <div id="right">
    <div class="footerNote">ì¢…ë£Œ í›„ 'ë‹¤ì‹œ ì‹œì‘'ìœ¼ë¡œ ìƒˆ ê²Œì„ ê°€ëŠ¥. ì ìˆ˜ëŠ” ë¸Œë¼ìš°ì €(LocalStorage)ì— ëˆ„ì ë©ë‹ˆë‹¤.</div>
  </div>
</div>

  </div>
</div><script>
/* ---------- ì´ˆê¸° ì„¸íŒ… ---------- */
const playerCountSelect = document.getElementById('playerCount');
for(let i=5;i<=12;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i+'ëª…'; playerCountSelect.appendChild(o); }
const startBtn = document.getElementById('startBtn');
const quickBtn = document.getElementById('quickBtn');
const resetScoreBtn = document.getElementById('resetScoreBtn');
const messages = document.getElementById('messages');
const playersDiv = document.getElementById('players');
const inputSection = document.getElementById('inputSection');
const revealBox = document.getElementById('reveal');
const revealList = document.getElementById('revealList');
const scoreList = document.getElementById('scoreList');
// DM UI
const dmTabs = document.getElementById('dmTabs');
const dmLog = document.getElementById('dmLog');
const dmInput = document.getElementById('dmInput');
const dmSendBtn = document.getElementById('dmSendBtn');

/* ---------- ì ìˆ˜: ì„¸ì…˜+ë¡œì»¬ ëˆ„ì  ---------- */
let scores = {}; // id -> score (ì„¸ì…˜)
const SCORE_KEY = 'singlemafia_scores_v2';
function loadScores(){ try{ const raw=localStorage.getItem(SCORE_KEY); if(raw){ scores = JSON.parse(raw)||{}; } }catch(e){} }
function saveScores(){ try{ localStorage.setItem(SCORE_KEY, JSON.stringify(scores)); }catch(e){} }
function ensureScores(n){ for(let i=0;i<n;i++) if(scores[i]===undefined) scores[i]=0; renderScores(); }
function renderScores(){ let html=''; const ids=Object.keys(scores).map(x=>parseInt(x)).sort((a,b)=>a-b); ids.forEach(id=> html += `í”Œë ˆì´ì–´ ${id+1}: ${scores[id]}ì <br/>`); scoreList.innerHTML = html || '-'; }
resetScoreBtn.onclick = ()=>{ if(confirm('ì €ì¥ëœ ì ìˆ˜ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')){ scores={}; saveScores(); renderScores(); } };
loadScores();
renderScores();

/* ---------- ê³µí†µ ìœ í‹¸ ---------- */
function log(msg,clear=false){ if(clear) messages.textContent=''; messages.textContent += msg + '\n'; messages.scrollTop = messages.scrollHeight; }
function mkBtn(label, cb){ const b=document.createElement('button'); b.textContent=label; b.onclick=cb; return b; }
function drawAvatar(container, id, role, alive){
  const size = 8, scale = 3, cvs = document.createElement('canvas');
  cvs.width = size; cvs.height = size; cvs.style.width=(size*scale)+'px'; cvs.style.height=(size*scale)+'px'; cvs.className='avatar';
  const ctx = cvs.getContext('2d'); function rnd(n){ const x = Math.sin(id*9781 + n*2654435761) * 10000; return Math.abs(x % 1); }
  const baseHue = Math.floor(rnd(1)*360);
  for(let y=0;y<size;y++)for(let x=0;x<size;x++){ const v = rnd(x*size+y)>0.5; const mafiaish = (role==='ë§ˆí”¼ì•„'||role==='ìŠ¤íŒŒì´'||role==='í›ˆë ¨ì‚¬'); const hue = mafiaish?0:(role==='ê²½ì°°'?210:(role==='ì˜ì‚¬'||role==='ê°„í˜¸ì‚¬'?60:180)); const c = v? `hsl(${(baseHue+hue)%360} 70% 50%)` : '#111'; ctx.fillStyle=c; ctx.fillRect(x,y,1,1); }
  if(!alive){ ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(0,0,size,size); ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='6px monospace'; ctx.fillText('X',2,6); }
  container.appendChild(cvs);
}

/* ---------- ì§ì—…/íŒ€ ---------- */
const TEAM = { MAFIA:'mafia', TOWN:'town', NEUTRAL:'neutral' };
const ROLES = {
  ë§ˆí”¼ì•„:    {team:TEAM.MAFIA},
  ìŠ¤íŒŒì´:    {team:TEAM.MAFIA},  // ì ‘ì„  í›„ ì •ë³´ ê³µìœ , ë‹¨ë… ìƒì¡´ ì‹œ ê³µê²©
  í›ˆë ¨ì‚¬:    {team:TEAM.MAFIA},  // ë°¤ ì§€ëª© â†’ ë‹¤ìŒ ë‚®+ë°¤ ë´‰ì¸, ë§ˆí”¼ì•„ ì§€ëª©ì‹œ ì ‘ì„ , ë‹¨ë… ìƒì¡´ ì‹œ ê³µê²©
  ê²½ì°°:     {team:TEAM.TOWN},
  ì˜ì‚¬:     {team:TEAM.TOWN},
  ê°„í˜¸ì‚¬:   {team:TEAM.TOWN},    // ì˜ì‚¬ ì‚¬ë§ ì‹œ ì¹˜ë£Œ ìŠ¹ê³„
  íŒì‚¬:     {team:TEAM.TOWN},    // ë‚® íˆ¬í‘œ ë¬´ì‹œ + ë‹¨ë… ì§€ëª© ì²˜í˜•, íˆ¬í‘œ ë©´ì—­
  ì •ì¹˜ì¸:   {team:TEAM.TOWN},    // íˆ¬í‘œ 2í‘œ, íˆ¬í‘œ ë©´ì—­
  ê¸°ì:     {team:TEAM.TOWN},    // ì§ìˆ˜ ë°¤ ì·¨ì¬ â†’ ì•„ì¹¨ì— ì§ì—… ê³µê°œ
  êµ°ì¸:     {team:TEAM.TOWN},    // ë§ˆí”¼ì•„ ê³µê²© 1íšŒ ë°©ì–´, ê²½ì°° ì‚¬ë§ ì‹œ ë°¤ 1íšŒ ì‚¬ê²©
  ë¬´ë‹¹:     {team:TEAM.TOWN},    // ì²« ì‚¬ë§ìì˜ ì§ì—… ê³„ìŠ¹
  íƒì •:     {team:TEAM.TOWN},    // ë°¤ ì¶”ì  â†’ ë‹¤ìŒ ë‚® ëŠ¥ë ¥ ì‚¬ìš© ì—¬ë¶€ ê³µê°œ
  í…ŒëŸ¬ë²”:   {team:TEAM.NEUTRAL}, // ë°¤ì— ë§ˆí”¼ì•„ì—ê²Œ í”¼ê²© ì‹œ ë™ë°˜ìí­, ë‚® ì²˜í˜• ì‹œ ë¬´ì‘ìœ„ 1ëª… ì¶”ê°€ ì‚¬ë§
};
const SUPPORT_POOL = ['ìŠ¤íŒŒì´','í›ˆë ¨ì‚¬'];
const SPECIAL_POOL = ['íŒì‚¬','ì •ì¹˜ì¸','ê¸°ì','êµ°ì¸','ë¬´ë‹¹','íƒì •','ê°„í˜¸ì‚¬','í…ŒëŸ¬ë²”'];

/* ---------- ì¸ì› ë°°ë¶„ ---------- */
function buildRolesByRule(n){
  let mafiaCore=0, support=0, police=0, doctor=0;
  if(n<=5){ mafiaCore=1; support=0; police=1; doctor=1; }
  else if(n<=7){ mafiaCore=1; support=1; police=1; doctor=1; }
  else if(n===8){ mafiaCore=2; support=1; police=1; doctor=2; }
  else if(n>=9 && n<=11){ mafiaCore=2; support=1; police=1; doctor=2; }
  else { mafiaCore=3; support=1; police=1; doctor=2; }
  const roles=[];
  for(let i=0;i<mafiaCore;i++) roles.push('ë§ˆí”¼ì•„');
  if(support>0) roles.push(SUPPORT_POOL[Math.floor(Math.random()*SUPPORT_POOL.length)]);
  for(let i=0;i<police;i++) roles.push('ê²½ì°°');
  for(let i=0;i<doctor;i++) roles.push('ì˜ì‚¬');
  const pool=[...SPECIAL_POOL];
  while(roles.length<n && pool.length){ const idx=Math.floor(Math.random()*pool.length); roles.push(pool.splice(idx,1)[0]); }
  while(roles.length<n){ roles.push(SPECIAL_POOL[Math.floor(Math.random()*SPECIAL_POOL.length)]); }
  for(let i=roles.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [roles[i],roles[j]]=[roles[j],roles[i]]; }
  return roles;
}

/* ---------- ìƒíƒœ ---------- */
let game=null;
function alivePlayers(){ return game.players.filter(p=>p.alive); }
function teamOf(p){ return ROLES[p.role].team; }

/* ---------- ë¹„ë°€ì°½ (DM/íŒ€ ì±„íŒ…) ---------- */
// ì±„ë„ í‚¤: 'p:ID' (1:1 DM), 'team:mafia' (ë§ˆí”¼ì•„ íŒ€ë°©)
let dmState = null; // { channels: {key: [{fromId,text,sys?:true,t}]}, visibleKeys:[], activeKey:'', access: Set(keys) }
function dmInit(){ dmState = { channels:{}, visibleKeys:[], activeKey:'', access:new Set() }; renderDmTabs(); renderDmLog(); }
function dmCanSee(key){ return dmState.access.has(key); }
function dmEnsure(key){ if(!dmState.channels[key]) dmState.channels[key]=[]; if(!dmState.visibleKeys.includes(key)) dmState.visibleKeys.push(key); }
function dmGrant(key){ dmState.access.add(key); dmEnsure(key); renderDmTabs(); }
function dmPost(key, fromId, text, sys=false){ dmEnsure(key); dmState.channels[key].push({fromId,text,sys,t:Date.now()}); if(dmState.activeKey===key) renderDmLog(); }
function dmSetActive(key){ if(!dmCanSee(key)) return; dmState.activeKey=key; renderDmTabs(); renderDmLog(); }
function renderDmTabs(){ dmTabs.innerHTML=''; const keys = dmState.visibleKeys.filter(k=>dmCanSee(k)); if(keys.length===0){ dmTabs.innerHTML='<span class="small">ì ‘ê·¼ ê°€ëŠ¥í•œ ë¹„ë°€ì°½ì´ ì—†ìŠµë‹ˆë‹¤</span>'; return; } keys.forEach(k=>{ const b=document.createElement('button'); b.className='dmTab'+(dmState.activeKey===k?' active':''); b.textContent = k.startsWith('team:')? (k==='team:mafia'?'ë§ˆí”¼ì•„íŒ€':'íŒ€'): dmTabTitle(k); b.onclick=()=> dmSetActive(k); dmTabs.appendChild(b); }); }
function dmTabTitle(key){ if(!key.startsWith('p:')) return key; const id=parseInt(key.split(':')[1]); return `${id+1}ë²ˆ` }
function renderDmLog(){ const key=dmState.activeKey; dmLog.innerHTML=''; if(!key){ dmLog.innerHTML='<span class="small">ì—´ë¦° ë¹„ë°€ì°½ ì—†ìŒ</span>'; return; }
  const lines = dmState.channels[key]||[]; if(lines.length===0){ dmLog.innerHTML='<span class="small">ë©”ì‹œì§€ ì—†ìŒ</span>'; return; }
  const meId = 0;
  dmLog.innerHTML = lines.map(m=>{
    if(m.sys) return `<div class="system">[ì‹œìŠ¤í…œ] ${escapeHtml(m.text)}</div>`;
    const who = (m.fromId===meId)? '<span class="me">ë‚˜</span>' : `<span class="them">${m.fromId+1}ë²ˆ</span>`;
    return `${who}: ${escapeHtml(m.text)}`;
  }).join('\n');
  dmLog.scrollTop = dmLog.scrollHeight;
}
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

// í”Œë ˆì´ì–´ê°€ ë³´ë‚¼ ë•Œ (í˜„ì¬ ì•¡í‹°ë¸Œ ì±„ë„ì—ë§Œ)
dmSendBtn.onclick = ()=>{
  const key = dmState.activeKey; const txt = dmInput.value.trim(); if(!key||!txt) return; if(!dmCanSee(key)) return;
  dmPost(key, 0, txt, false); dmInput.value='';
  // AIëŠ” íŠ¹ë³„í•œ ë°˜ì‘ì€ í•˜ì§€ ì•Šì§€ë§Œ, ë¡œê·¸ëŠ” ì €ì¥ë¨
};

/* ---------- ë Œë” ---------- */
function renderPlayers(){
  playersDiv.innerHTML='';
  game.players.forEach(p=>{
    const card=document.createElement('div'); card.className='playerCard';
    const avw=document.createElement('div'); avw.style.width='36px';
    drawAvatar(avw, p.id+11, p.role, p.alive);
    const info=document.createElement('div'); info.className='playerInfo';
    const title=document.createElement('div'); title.textContent=(p.id+1)+(p.id===0?' (ë‹¹ì‹ )':'');
    const badge=document.createElement('span'); badge.className='badge'; badge.textContent=p.alive?'ìƒì¡´':'ì‚¬ë§';
    title.appendChild(badge);
    const sub=document.createElement('div'); sub.className='small'; sub.style.color='#bfbfbf';
    sub.textContent=''; // â˜… ì˜ì‹¬í‘œì‹œ(ë§ˆí”¼ì•„ ì¶”ì •) ì™„ì „ ë¹„í™œì„±í™”
    info.appendChild(title); info.appendChild(sub);
    if(!p.alive) card.classList.add('dead');
    if(p.id===0) card.classList.add('you');
    card.appendChild(avw); card.appendChild(info);
    playersDiv.appendChild(card);
  });
}

/* ---------- ì‹œì‘ ---------- */
startBtn.onclick = ()=> startGame(parseInt(playerCountSelect.value));
quickBtn.onclick = ()=>{ playerCountSelect.value=8; startGame(8); };

function startGame(n){
  const roles = buildRolesByRule(n);
  game = {
    players: roles.map((r,i)=>({ id:i, role:r, alive:true, flags:{
      soldierArmor: r==='êµ°ì¸', usedSoldierShot:false, // êµ°ì¸
      blockedUntilDay:0, // í›ˆë ¨ì‚¬ ë´‰ì¸
    }})),
    day:0, night:0, phase:'night',
    firstDeathRole:null,
    mafiaContact: { spy:false, trainer:false },
    spyKnown: [],                // ìŠ¤íŒŒì´ê°€ ì•Œê²Œ ëœ ì •ë³´ (id:role)
    trainerPickCount: {},        // í›ˆë ¨ì‚¬ê°€ ì§€ëª©í•œ íšŸìˆ˜ ë³´ê³ ìš© (ëŒ€ìƒë³„ ëˆ„ì )
    nightActs:{},                // ì´ë²ˆ ë°¤ ì•¡ì…˜ ì €ì¥
    journalistReveal:null,       // ì•„ì¹¨ ê³µê°œ í…ìŠ¤íŠ¸
    detectiveMsg:null,           // ì•„ì¹¨ íƒì • ë©”ì‹œì§€
    soldierShotAvailable:false,  // ê²½ì°° ì‚¬ë§ í›„
    suspicion: {},               // íˆ¬í‘œ AIìš© ì˜ì‹¬ë„ (id -> score)
    lastVotes: {},               // ì§€ë‚œ ë‚® ëˆ„ê°€ ëˆ„êµ¬ì—ê²Œ íˆ¬í‘œí–ˆëŠ”ì§€ (voterId -> targetId)
  };
  ensureScores(n);
  dmInit();
  // ì´ˆê¸°ì— ë‚´ê°€ ë³¼ ìˆ˜ ìˆëŠ” DM ì±„ë„ ì„¤ì • (ê°œì¸ DM ì „ì²´ í‘œì‹œ, ë‚´ìš©ì€ ì‹œìŠ¤í…œì´ ë„£ì–´ì¤„ ë•Œë§Œ ì—´ë¦¼)
  for(let i=1;i<n;i++){ dmGrant('p:'+i); }
  renderDmTabs(); dmSetActive('p:1');

  log(`(ì‹œì‘) ${n}ëª… ê²Œì„. ì§ì—…ì€ ë¹„ê³µê°œ, ì˜ì‹¬í‘œì‹œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`, true);
  renderPlayers();
  setTimeout(()=> nextPhase('night'), 600);
}

function nextPhase(phase){
  game.phase=phase;
  inputSection.innerHTML='';
  if(phase==='night') nightPhase();
  else if(phase==='day') dayPhase();
  else if(phase==='end') endPhase();
}

/* ---------- NIGHT ---------- */
function canUseAbility(p){ if(!p.alive) return false; if(game.day < p.flags.blockedUntilDay) return false; return true; }
function pickRandomAlive(filterFn){ const cand = alivePlayers().filter(filterFn||(()=>true)); return cand.length? cand[Math.floor(Math.random()*cand.length)]:null; }

function nightPhase(){
  game.night++; game.nightActs = {};
  game.journalistReveal=null; game.detectiveMsg=null;
  log(`\nğŸŒ™ ë°¤ ${game.night} ì‹œì‘`);
  renderPlayers();

  if(!game.players[0].alive){ log('ë‹¹ì‹ ì€ ì‚¬ë§í•´ ë°¤ í–‰ë™ ì—†ìŒ.'); return setTimeout(aiNightActions,700); }

  const me = game.players[0];
  const alive = alivePlayers();

  const addTargetButtons=(label,cb,filter=()=>true)=>{
    const wrap=document.createElement('div');
    wrap.innerHTML=`<div class="small">${label}</div>`;
    alive.filter(x=>x.id!==me.id && filter(x)).forEach(t=> wrap.appendChild(mkBtn((t.id+1)+'ë²ˆ', ()=>{ cb(t.id); inputSection.innerHTML=''; setTimeout(aiNightActions,400);})));
    inputSection.appendChild(wrap);
  };

  if(me.role==='ë§ˆí”¼ì•„'){
    log('ë‹¹ì‹ (ë§ˆí”¼ì•„)ì€ ê³µê²© ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.');
    addTargetButtons('ê³µê²© ëŒ€ìƒ', (id)=>{ game.nightActs.mafiaKill=id; log(`ë§ˆí”¼ì•„ ê³µê²©: ${id+1}ë²ˆ ì§€ì •.`); }, t=>teamOf(t)!==TEAM.MAFIA);
    dmGrant('team:mafia'); if(!dmState.activeKey) dmSetActive('team:mafia');
  } else if(me.role==='ìŠ¤íŒŒì´'){
    log('ë‹¹ì‹ (ìŠ¤íŒŒì´)ì€ ì§ì—… íƒì§€ ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”. (ë§ˆí”¼ì•„ë¥¼ ì„ íƒí•˜ë©´ ì ‘ì„ )');
    addTargetButtons('íƒì§€ ëŒ€ìƒ', (id)=>{ game.nightActs.spyPeek=id; log(`ìŠ¤íŒŒì´ íƒì§€: ${id+1}ë²ˆ.`); });
    if(isSpySoloActive()) addTargetButtons('ìŠ¤íŒŒì´(ë‹¨ë… ìƒì¡´) ê³µê²© ëŒ€ìƒ', (id)=>{ game.nightActs.spyKill=id; log(`ìŠ¤íŒŒì´ ë‹¨ë…ê³µê²©: ${id+1}ë²ˆ.`); }, t=>t.id!==me.id);
  } else if(me.role==='í›ˆë ¨ì‚¬'){
    log('ë‹¹ì‹ (í›ˆë ¨ì‚¬)ì€ ë‹¤ìŒë‚  ë‚®+ë°¤ ë™ì•ˆ ëŠ¥ë ¥ì„ ë´‰ì¸í•  ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”. (ë§ˆí”¼ì•„ ì§€ëª© ì‹œ ì ‘ì„ )');
    addTargetButtons('ë´‰ì¸ ëŒ€ìƒ', (id)=>{ game.nightActs.trainerBlock=id; log(`í›ˆë ¨ì‚¬ ë´‰ì¸: ${id+1}ë²ˆ.`); });
    if(isTrainerSoloActive()) addTargetButtons('í›ˆë ¨ì‚¬(ë‹¨ë… ìƒì¡´) ê°œ ê³µê²© ëŒ€ìƒ', (id)=>{ game.nightActs.trainerKill=id; log(`í›ˆë ¨ì‚¬ ê°œê³µê²©: ${id+1}ë²ˆ.`); });
  } else if(me.role==='ì˜ì‚¬' || (me.role==='ê°„í˜¸ì‚¬' && nurseActing())){
    log(`ë‹¹ì‹ (${me.role})ì€ ì¹˜ë£Œ ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.`);
    addTargetButtons('ì¹˜ë£Œ ëŒ€ìƒ', (id)=>{ game.nightActs.heal=id; log(`${me.role} ì¹˜ë£Œ: ${id+1}ë²ˆ.`); });
  } else if(me.role==='ê²½ì°°'){
    log('ë‹¹ì‹ (ê²½ì°°)ì€ ì¡°ì‚¬ ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”.');
    addTargetButtons('ì¡°ì‚¬ ëŒ€ìƒ', (id)=>{ game.nightActs.policeCheck=id; log(`ê²½ì°° ì¡°ì‚¬: ${id+1}ë²ˆ.`); }, t=>t.id!==me.id);
  } else if(me.role==='íƒì •'){
    log('ë‹¹ì‹ (íƒì •)ì€ ì¶”ì  ëŒ€ìƒì„ ê³ ë¥´ì„¸ìš”. (ë‹¤ìŒ ë‚®ì— ëŠ¥ë ¥ ì‚¬ìš© ì—¬ë¶€ ê³µê°œ)');
    addTargetButtons('ì¶”ì  ëŒ€ìƒ', (id)=>{ game.nightActs.detectiveTrack=id; log(`íƒì • ì¶”ì : ${id+1}ë²ˆ.`); }, t=>t.id!==me.id);
  } else if(me.role==='êµ°ì¸' && game.soldierShotAvailable && !me.flags.usedSoldierShot){
    log('ë‹¹ì‹ (êµ°ì¸)ì€ 1íšŒ ì‚¬ê²©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    addTargetButtons('ì‚¬ê²© ëŒ€ìƒ(1íšŒ)', (id)=>{ game.nightActs.soldierShot=id; game.players[0].flags.usedSoldierShot=true; game.soldierShotAvailable=false; log(`êµ°ì¸ ì‚¬ê²©: ${id+1}ë²ˆ.`); });
  } else {
    log(`ë‹¹ì‹ (${me.role})ì€ ë°¤ í–‰ë™ ì—†ìŒ.`);
    setTimeout(aiNightActions, 600);
  }
}

function nurseActing(){
  const doctorAlive = game.players.some(p=>p.role==='ì˜ì‚¬' && p.alive);
  const nurse = game.players.find(p=>p.role==='ê°„í˜¸ì‚¬' && p.alive);
  return nurse && !doctorAlive;
}
function isSpySoloActive(){ const spy = game.players.find(p=>p.role==='ìŠ¤íŒŒì´' && p.alive); if(!spy) return false; const mafiaAlive = alivePlayers().filter(p=> teamOf(p)===TEAM.MAFIA && p.role!=='ìŠ¤íŒŒì´' && p.role!=='í›ˆë ¨ì‚¬'); return mafiaAlive.length===0; }
function isTrainerSoloActive(){ const tr = game.players.find(p=>p.role==='í›ˆë ¨ì‚¬' && p.alive); if(!tr) return false; const mafiaAlive = alivePlayers().filter(p=> teamOf(p)===TEAM.MAFIA && p.role!=='ìŠ¤íŒŒì´' && p.role!=='í›ˆë ¨ì‚¬'); return mafiaAlive.length===0; }

/* AI ë°¤ í–‰ë™ */
function aiNightActions(){
  const alive = alivePlayers();
  const usedBy = new Set(); // íƒì •ìš©
  const addUsed = (id)=>{ if(id!=null) usedBy.add(id); };
  const A = game.nightActs;

  // ë§ˆí”¼ì•„ ë³¸ëŒ€ ê³µê²©
  if(A.mafiaKill==null){
    const mafiaSide = alive.filter(p=> teamOf(p)===TEAM.MAFIA && p.role==='ë§ˆí”¼ì•„');
    if(mafiaSide.length){
      // íƒ€ê¹ƒ ì ìˆ˜: ê²½ì°°>ì˜ì‚¬/ê°„í˜¸ì‚¬>íŒì‚¬>ì •ì¹˜ì¸>ê¸°íƒ€
      let best=null, bestS=-1e9;
      alive.filter(p=> teamOf(p)!==TEAM.MAFIA).forEach(c=>{
        let s= (c.role==='ê²½ì°°')? 50 : (c.role==='ì˜ì‚¬'||c.role==='ê°„í˜¸ì‚¬')? 30 : (c.role==='íŒì‚¬')? 28 : (c.role==='ì •ì¹˜ì¸')? 20 : 10;
        s += (game.suspicion[c.id]||0)*0.3;
        s += Math.random()*5;
        if(s>bestS){ bestS=s; best=c; }
      });
      if(best){ A.mafiaKill=best.id; log(`AI ë§ˆí”¼ì•„ê°€ ${best.id+1}ë²ˆ ê³µê²©ì„ ì„ íƒ.`); addUsed(mafiaSide[0].id); }
    } else {
      // ë§ˆí”¼ì•„ ì „ë©¸ â†’ ë³´ì¡° ë‹¨ë… ê³µê²©
      if(isSpySoloActive() && A.spyKill==null){ const t = pickRandomAlive(p=>p.role!=='ìŠ¤íŒŒì´'); if(t){ A.spyKill=t.id; log(`AI ìŠ¤íŒŒì´ê°€ ë‹¨ë… ê³µê²©ìœ¼ë¡œ ${t.id+1}ë²ˆì„ ì„ íƒ.`); addUsed(game.players.find(p=>p.role==='ìŠ¤íŒŒì´'&&p.alive)?.id); } }
      if(isTrainerSoloActive() && A.trainerKill==null){ const t = pickRandomAlive(p=>p.role!=='í›ˆë ¨ì‚¬'); if(t){ A.trainerKill=t.id; log(`AI í›ˆë ¨ì‚¬ê°€ ê°œê³µê²©ìœ¼ë¡œ ${t.id+1}ë²ˆì„ ì„ íƒ.`); addUsed(game.players.find(p=>p.role==='í›ˆë ¨ì‚¬'&&p.alive)?.id); } }
    }
  }

  // ìŠ¤íŒŒì´ íƒì§€
  if(A.spyPeek==null){ const spy = alive.find(p=>p.role==='ìŠ¤íŒŒì´' && p.id!==0); if(spy && canUseAbility(spy)){ const t = pickRandomAlive(p=>p.id!==spy.id); if(t){ A.spyPeek=t.id; log(`AI ìŠ¤íŒŒì´ê°€ ${t.id+1}ë²ˆì„ íƒì§€ ëŒ€ìƒìœ¼ë¡œ ì„ íƒ.`); addUsed(spy.id); } } }
  // í›ˆë ¨ì‚¬ ë´‰ì¸
  if(A.trainerBlock==null){ const tr = alive.find(p=>p.role==='í›ˆë ¨ì‚¬' && p.id!==0); if(tr && canUseAbility(tr)){ const t = pickRandomAlive(p=>p.id!==tr.id); if(t){ A.trainerBlock=t.id; log(`AI í›ˆë ¨ì‚¬ê°€ ${t.id+1}ë²ˆ ë´‰ì¸ì„ ì„ íƒ.`); addUsed(tr.id); } } }
  // ì˜ì‚¬/ê°„í˜¸ì‚¬ ì¹˜ë£Œ
  if(A.heal==null){ const doc = alive.find(p=> (p.role==='ì˜ì‚¬' || (p.role==='ê°„í˜¸ì‚¬' && nurseActing())) && p.id!==0); if(doc && canUseAbility(doc)){ const cops = alive.filter(p=>p.role==='ê²½ì°°'); const pri = cops.length? cops[0]: pickRandomAlive(); if(pri){ A.heal = pri.id; log(`AI ${doc.role}ê°€ ${pri.id+1}ë²ˆ ì¹˜ë£Œ.`); addUsed(doc.id); } } }
  // ê²½ì°° ì¡°ì‚¬
  if(A.policeCheck==null){ const cop = alive.find(p=>p.role==='ê²½ì°°' && p.id!==0); if(cop && canUseAbility(cop)){ const t = pickRandomAlive(p=>p.id!==cop.id); if(t){ A.policeCheck=t.id; log(`AI ê²½ì°°ì´ ${t.id+1}ë²ˆì„ ì¡°ì‚¬.`); addUsed(cop.id);} } }
  // êµ°ì¸ ì‚¬ê²©
  if(game.soldierShotAvailable && A.soldierShot==null){ const sol = alive.find(p=>p.role==='êµ°ì¸' && p.id!==0 && !p.flags.usedSoldierShot); if(sol){ const t = pickRandomAlive(p=>p.id!==sol.id); if(t){ A.soldierShot=t.id; sol.flags.usedSoldierShot=true; game.soldierShotAvailable=false; log(`AI êµ°ì¸ì´ ${t.id+1}ë²ˆì„ ì‚¬ê²©.`); addUsed(sol.id);} } }
  // ê¸°ì ì·¨ì¬(ì§ìˆ˜ ë°¤)
  const journ = alive.find(p=>p.role==='ê¸°ì'); if(journ && (game.night%2===0) && canUseAbility(journ)){ const t = pickRandomAlive(p=>p.id!==journ.id); if(t){ A.journalistTarget=t.id; addUsed(journ.id); } }
  // íƒì • ì¶”ì 
  if(A.detectiveTrack==null){ const det = alive.find(p=>p.role==='íƒì •' && p.id!==0); if(det && canUseAbility(det)){ const t = pickRandomAlive(p=>p.id!==det.id); if(t){ A.detectiveTrack=t.id; addUsed(det.id); } } }

  game._usedByThisNight = usedBy;
  setTimeout(resolveNight, 700);
}

/* ë°¤ í•´ê²° */
function resolveNight(){
  const A = game.nightActs; const kills = new Set(); const alive = alivePlayers();

  // í›ˆë ¨ì‚¬ ë´‰ì¸
  if(A.trainerBlock!=null){
    const trTarget = game.players[A.trainerBlock];
    if(trTarget){
      trTarget.flags.blockedUntilDay = Math.max(trTarget.flags.blockedUntilDay, game.day+1);
      game.trainerPickCount[trTarget.id] = (game.trainerPickCount[trTarget.id]||0)+1;
      // ì ‘ì„  í™•ì¸
      if(ROLES[trTarget.role].team===TEAM.MAFIA){
        if(!game.mafiaContact.trainer){ dmGrant('team:mafia'); }
        game.mafiaContact.trainer = true;
        dmPost('team:mafia', -1, `í›ˆë ¨ì‚¬ê°€ ë§ˆí”¼ì•„(${trTarget.id+1})ë¥¼ ì§€ëª©í•˜ì—¬ ì ‘ì„  ì„±ë¦½.`, true);
      } else if(game.mafiaContact.trainer){
        dmPost('team:mafia', -1, `í›ˆë ¨ì‚¬ ë³´ê³ : ${trTarget.id+1}ë²ˆì„ ëˆ„ì  ${game.trainerPickCount[trTarget.id]}íšŒ ë´‰ì¸.`, true);
      }
    }
  }

  // ìŠ¤íŒŒì´ íƒì§€
  if(A.spyPeek!=null){
    const t = game.players[A.spyPeek];
    if(t){
      if(ROLES[t.role].team===TEAM.MAFIA){
        if(!game.mafiaContact.spy){ dmGrant('team:mafia'); }
        game.mafiaContact.spy = true;
        dmPost('team:mafia', -1, `ìŠ¤íŒŒì´ê°€ ë§ˆí”¼ì•„(${t.id+1})ì™€ ì ‘ì„ í–ˆìŠµë‹ˆë‹¤.`, true);
      } else {
        const info = `${t.id+1}ë²ˆì€ ${t.role}`;
        game.spyKnown.push({id:t.id, role:t.role});
        if(game.mafiaContact.spy) dmPost('team:mafia', -1, `ìŠ¤íŒŒì´ ì •ë³´: ${info}`, true);
        else dmPost('p:'+t.id, -1, `ìŠ¤íŒŒì´ê°€ í™•ì¸: ${info}`, true);
        // ì˜ì‹¬ë„ ë³´ì •: ë§ˆí”¼ì•„ ì•„ë‹˜ì´ í™•ì •ì´ë©´ ì˜ì‹¬ í•˜í–¥
        if(ROLES[t.role].team!==TEAM.MAFIA) game.suspicion[t.id] = (game.suspicion[t.id]||0) - 10;
      }
    }
  }

  // êµ°ì¸ ì‚¬ê²©
  if(A.soldierShot!=null){ const t = game.players[A.soldierShot]; if(t && t.alive){ kills.add(t.id); log(`ë°¤: êµ°ì¸ì´ ${t.id+1}ë²ˆì„ ì‚¬ê²©.`); } }

  // ë§ˆí”¼ì•„ì¸¡ ê³µê²© (ìš°ì„ ìˆœìœ„: ë³¸ëŒ€ > ìŠ¤íŒŒì´ > í›ˆë ¨ì‚¬)
  let attackVictim = null;
  if(A.mafiaKill!=null) attackVictim = game.players[A.mafiaKill];
  else if(A.spyKill!=null) attackVictim = game.players[A.spyKill];
  else if(A.trainerKill!=null) attackVictim = game.players[A.trainerKill];

  if(attackVictim){
    const t = attackVictim;
    if(A.heal===t.id){ log(`ë°¤: ${t.id+1}ë²ˆì€ ì¹˜ë£Œë¡œ ìƒì¡´.`); }
    else if(t.role==='êµ°ì¸' && t.flags.soldierArmor){ t.flags.soldierArmor=false; log(`ë°¤: êµ°ì¸(${t.id+1})ì´ ë°©íƒ„ìœ¼ë¡œ ìƒì¡´(íšŒìˆ˜ 0).`); }
    else {
      if(t.role==='í…ŒëŸ¬ë²”'){ const maf = alivePlayers().filter(p=> teamOf(p)===TEAM.MAFIA); if(maf.length){ const m = maf[Math.floor(Math.random()*maf.length)]; kills.add(m.id); log(`ë°¤: í…ŒëŸ¬ë²”(${t.id+1}) ìí­ìœ¼ë¡œ ë§ˆí”¼ì•„(${m.id+1}) ë™ë°˜ ì‚¬ë§.`); } }
      kills.add(t.id); log(`ë°¤: ê³µê²©ìœ¼ë¡œ ${t.id+1}ë²ˆ ì‚¬ë§.`);
    }
  } else { log('ë°¤: ë§ˆí”¼ì•„ì¸¡ì˜ ê³µê²© ì—†ìŒ.'); }

  // ì‚¬ë§ ì²˜ë¦¬ + ì²« ì‚¬ë§ì â†’ ë¬´ë‹¹ ë³€ì‹ 
  const preAlive = alivePlayers().map(p=>p.id);
  kills.forEach(id=>{ const p=game.players[id]; if(p && p.alive){ p.alive=false; if(!game.firstDeathRole) game.firstDeathRole=p.role; }});
  if(game.firstDeathRole){ const shaman = alivePlayers().find(p=>p.role==='ë¬´ë‹¹'); if(shaman && !shaman.flags.morphed){ shaman.role = game.firstDeathRole; shaman.flags.morphed = true; log(`ìƒˆë²½: ë¬´ë‹¹ì´ ì²« ì‚¬ë§ìì˜ ì§ì—…(${game.firstDeathRole})ìœ¼ë¡œ ë³€í–ˆìŠµë‹ˆë‹¤.`); } }

  // ê²½ì°° ì‚¬ë§ ì—¬ë¶€ ì²´í¬ â†’ êµ°ì¸ ì‚¬ê²© ê°€ëŠ¥
  const anyPolice = game.players.some(p=>p.role==='ê²½ì°°');
  const policeAlive = alivePlayers().some(p=>p.role==='ê²½ì°°');
  if(anyPolice && !policeAlive && !game._policeWasDead){ game.soldierShotAvailable=true; log(`ì•Œë¦¼: ê²½ì°°ì´ ëª¨ë‘ ì‚¬ë§. êµ°ì¸ì´ ë°¤ì— 1íšŒ ì‚¬ê²© ê°€ëŠ¥.`); }
  game._policeWasDead = !policeAlive;

  // ê¸°ì ê³µê°œ(ì§ìˆ˜ ë°¤)
  if(A.journalistTarget!=null){ const t = game.players[A.journalistTarget]; if(t){ game.journalistReveal = `ê¸°ì: ${t.id+1}ë²ˆì˜ ì§ì—…ì€ ${t.role}ì…ë‹ˆë‹¤.`; if(ROLES[t.role].team===TEAM.MAFIA) game.suspicion[t.id]=(game.suspicion[t.id]||0)+35; else game.suspicion[t.id]=(game.suspicion[t.id]||0)-8; } }

  // íƒì • ê³µê°œ(ëŠ¥ë ¥ ì‚¬ìš© ì—¬ë¶€)
  if(A.detectiveTrack!=null){ const tracked = A.detectiveTrack; const used = game._usedByThisNight && game._usedByThisNight.has(tracked); if(used){ game.detectiveMsg = `íƒì •: ${tracked+1}ë²ˆì´ ì „ë‚  ë°¤ì— ëŠ¥ë ¥ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`; game.suspicion[tracked]=(game.suspicion[tracked]||0)+6; } else { game.detectiveMsg = `íƒì •: ${tracked+1}ë²ˆì€ ì „ë‚  ë°¤ì— ëŠ¥ë ¥ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`; } }

  renderPlayers();

  if(!game.players[0].alive){ log('\në‹¹ì‹ ì´ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤. ê²Œì„ì€ ìë™ ì§„í–‰ë©ë‹ˆë‹¤.'); }

  if(checkWin()) return setTimeout(()=> nextPhase('end'), 900);
  setTimeout(()=> nextPhase('day'), 900);
}

/* ---------- DAY ---------- */
function dayPhase(){
  game.day++;
  log(`\nâ˜€ ë‚® ${game.day} ì‹œì‘`);
  if(game.journalistReveal) log(game.journalistReveal);
  if(game.detectiveMsg) log(game.detectiveMsg);

  renderPlayers();

  const alive = alivePlayers();
  const judge = alive.find(p=>p.role==='íŒì‚¬');
  const playerAlive = game.players[0].alive;

  if(judge){
    log('íŒì‚¬ê°€ ìƒì¡´: ì¼ë°˜ íˆ¬í‘œëŠ” ë¬´ì‹œë˜ë©°, íŒì‚¬ê°€ 1ëª…ì„ ì§€ëª©í•´ ì²˜í˜•í•©ë‹ˆë‹¤. (íŒì‚¬/ì •ì¹˜ì¸ì€ íˆ¬í‘œë¡œ ì£½ì§€ ì•ŠìŒ)');
    if(playerAlive && game.players[0].role==='íŒì‚¬'){
      inputSection.innerHTML='';
      alive.filter(x=>x.id!==0).forEach(t=>{ inputSection.appendChild(mkBtn(`${t.id+1}ë²ˆ ì²˜í˜•`, ()=>{ executeByJudge(t.id); })); });
    } else {
      setTimeout(()=> aiJudgeExecute(judge.id), 900);
    }
    return;
  }

  // ì¼ë°˜ íˆ¬í‘œ
  if(!playerAlive){
    log('ë‹¹ì‹ ì€ ì£½ì–´ íˆ¬í‘œ ë¶ˆê°€. AIê°€ íˆ¬í‘œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
    setTimeout(()=> aiVoteResolve(null), 800);
  } else {
    inputSection.innerHTML='<div class="small">ëˆ„êµ¬ë¥¼ ì²˜í˜•í• ê¹Œìš”? (ë³¸ì¸ ì œì™¸) â€” ì •ì¹˜ì¸/íŒì‚¬ëŠ” íˆ¬í‘œë¡œ ì£½ì§€ ì•ŠìŒ, ë™ì ì´ë©´ ì²˜í˜• ì—†ìŒ</div>';
    alive.filter(p=>p.id!==0).forEach(p=> inputSection.appendChild(mkBtn(`${p.id+1}ë²ˆ`, ()=>{ inputSection.innerHTML=''; aiVoteResolve(p.id /* ë‚´ í‘œ ëŒ€ìƒ */); })));
  }
}

function executeByJudge(targetId){
  const t = game.players[targetId]; if(!t || !t.alive) return; if(t.role==='íŒì‚¬'){ log('íŒì‚¬ëŠ” ìŠ¤ìŠ¤ë¡œë¥¼ ì²˜í˜•í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  t.alive=false; log(`ë‚®: íŒì‚¬ê°€ ${targetId+1}ë²ˆì„ ì²˜í˜•í–ˆìŠµë‹ˆë‹¤.`);
  if(t.role==='í…ŒëŸ¬ë²”'){ const r = pickRandomAlive(); if(r){ r.alive=false; log(`ë‚®: í…ŒëŸ¬ë²”(${t.id+1})ì´ ë¬´ì‘ìœ„(${r.id+1})ë¥¼ í•¨ê»˜ ì‚¬ë§ì‹œí‚´.`);} }
  renderPlayers();
  if(checkWin()) setTimeout(()=> nextPhase('end'),800); else setTimeout(()=> nextPhase('night'),800);
}
function aiJudgeExecute(judgeId){ const cand = alivePlayers().filter(p=>p.id!==judgeId); if(!cand.length) return setTimeout(()=> nextPhase('night'),600); const t = cand[Math.floor(Math.random()*cand.length)]; executeByJudge(t.id); }

/* ---------- íˆ¬í‘œ: ìŠ¤ë§ˆíŠ¸ AI ---------- */
function candidateScoreFor(voter, target){
  if(!target.alive) return -1e9;
  if(voter.id===target.id) return -1e9;
  // íˆ¬í‘œ ë©´ì—­ì´ë©´ ìš°ì„ ìˆœìœ„ ë‚®ì¶¤
  const immune = (target.role==='ì •ì¹˜ì¸'||target.role==='íŒì‚¬');
  let s = 0;
  // ê¸°ë³¸ ê·œì¹™
  if(teamOf(voter)===TEAM.MAFIA){
    // ë§ˆí”¼ì•„ëŠ” íƒ€ìš´/ì¤‘ë¦½ì„ ì„ í˜¸, ë‹¨ ë™ì›ë ¥ ë†’ì€ ì—­í•  ê°€ì¤‘
    s += (teamOf(target)===TEAM.MAFIA)? -999 : 0; // ë™ë£Œ ë°°ì²™
    s += (target.role==='ê²½ì°°')? 50 : (target.role==='ì˜ì‚¬'||target.role==='ê°„í˜¸ì‚¬')? 35 : (target.role==='íŒì‚¬')? 40 : (target.role==='ì •ì¹˜ì¸')? 30 : 10;
  } else if(teamOf(voter)===TEAM.TOWN){
    // íƒ€ìš´ì€ ì˜ì‹¬ë„ê°€ í•µì‹¬
    s += (game.suspicion[target.id]||0);
    // ê¸°ìê°€ ë§ˆí”¼ì•„ë¼ê³  ë°íŒ ê²½ìš° ì´ë¯¸ suspicionì— ë°˜ì˜ë¨
    s += (target.role==='ë§ˆí”¼ì•„'||target.role==='ìŠ¤íŒŒì´'||target.role==='í›ˆë ¨ì‚¬')? 12 : 0;
  } else {
    // ì¤‘ë¦½(í…ŒëŸ¬ë²”) â€” ë¬´ì‘ìœ„ì„± + ê°•í•œ ì—­í•  ì†Œê±° ì„±í–¥
    s += (target.role==='ê²½ì°°'||target.role==='ì˜ì‚¬'||target.role==='íŒì‚¬')? 15 : 5;
  }
  // ìµœê·¼ ë‚˜ì—ê²Œ íˆ¬í‘œí–ˆë˜ ì‚¬ëŒì— ëŒ€í•œ ì•™ì‹¬ ì†ŒëŸ‰
  const last = Object.entries(game.lastVotes).find(([vid,tid])=> parseInt(vid)===target.id && tid===voter.id);
  if(last) s += 4;
  // ë©´ì—­ì´ë©´ ì ìˆ˜ í•˜í–¥
  if(immune) s -= 25;
  // ì†ŒëŸ‰ ëœë¤ì„±
  s += Math.random()*3;
  return s;
}

function aiVoteResolve(playerVoteTarget){
  const votes = {}; const alive = alivePlayers();
  function addVote(id, weight=1){ votes[id]=(votes[id]||0)+weight; }

  // ë‚´ í‘œ ë¨¼ì € (ì •ì¹˜ì¸ì€ 2í‘œ)
  if(playerVoteTarget!=null){ addVote(playerVoteTarget, (game.players[0].role==='ì •ì¹˜ì¸'?2:1)); game.lastVotes[0]=playerVoteTarget; }

  // AIë“¤ í‘œ
  alive.forEach(voter=>{
    if(voter.id===0) return;
    // í›„ë³´ë“¤ ì¤‘ ì ìˆ˜ ìµœëŒ“ê°’ ì„ íƒ
    let bestId=null, bestS=-1e9;
    alive.forEach(target=>{
      if(target.id===voter.id) return;
      const s = candidateScoreFor(voter, target);
      if(s>bestS){ bestS=s; bestId=target.id; }
    });
    if(bestId!=null){ const w = (voter.role==='ì •ì¹˜ì¸'?2:1); addVote(bestId, w); game.lastVotes[voter.id]=bestId; }
  });

  // ë§ˆí”¼ì•„ íŒ€ì€ íŒ€ ë‚´ ê°„ë‹¨í•œ í‘œ ì •ë ¬(ë™ì¡°) â€” ê°€ì¥ ë†’ì€ ë“í‘œ ì˜ˆìƒìì—ê²Œ í•©ë¥˜
  const mafiaVoters = alive.filter(p=> teamOf(p)===TEAM.MAFIA);
  if(mafiaVoters.length){
    // ë“í‘œ ì˜ˆì¸¡: votes ê¸°ì¤€ìœ¼ë¡œ ìƒìœ„ í›„ë³´ ì‚°ì •
    let leader=null, m=0; for(const [id,c] of Object.entries(votes)){ if(c>m){ m=c; leader=parseInt(id);} }
    if(leader!=null){ mafiaVoters.forEach(mv=>{ if(game.lastVotes[mv.id]!==leader){ const w=(mv.role==='ì •ì¹˜ì¸'?2:1); votes[leader]=(votes[leader]||0)+w; } }); }
  }

  // ì§‘ê³„ ì¶œë ¥
  log('\níˆ¬í‘œ ì§‘ê³„:'); Object.entries(votes).forEach(([id,c])=> log(`${parseInt(id)+1}ë²ˆ: ${c}í‘œ`));

  // ìµœë‹¤ ë“í‘œì ê²°ì •
  let max=0, winners=[]; for(const [id,c] of Object.entries(votes)){ if(c>max){max=c; winners=[parseInt(id)];} else if(c===max){ winners.push(parseInt(id)); } }
  if(winners.length===1){
    const t = game.players[winners[0]];
    if(t.role==='ì •ì¹˜ì¸' || t.role==='íŒì‚¬'){ log(`ë‚®: ${t.role}(${t.id+1})ì€/ëŠ” íˆ¬í‘œë¡œ ì£½ì§€ ì•ŠìŠµë‹ˆë‹¤.`); }
    else {
      t.alive=false; log(`ë‚®: ${t.id+1}ë²ˆì´ ì²˜í˜•ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      // í…ŒëŸ¬ë²” ë‚® ìí­
      if(t.role==='í…ŒëŸ¬ë²”'){ const r = pickRandomAlive(); if(r){ r.alive=false; log(`ë‚®: í…ŒëŸ¬ë²”(${t.id+1})ì´ ë¬´ì‘ìœ„(${r.id+1})ì™€ ë™ë°˜ì‚¬ë§.`);} }
      // ì²˜í˜•ëœ ëŒ€ìƒì´ ë§ˆí”¼ì•„ì¸¡ì´ë©´ ì˜ì‹¬ë„ í•˜í–¥ ë³´ì •, íƒ€ìš´ì´ë©´ ë°˜ëŒ€ë¡œ ì•½ê°„ ì¦ê°€ (í•™ìŠµ ëŠë‚Œ)
      const isM = (teamOf(t)===TEAM.MAFIA); alivePlayers().forEach(p=>{ if(p.id!==t.id) game.suspicion[p.id] = (game.suspicion[p.id]||0) + (isM?-2:1); });
    }
  } else { log('ë‚®: ë™ì /ë¬´íš¨ë¡œ ì²˜í˜• ì—†ìŒ.'); }

  renderPlayers();
  if(checkWin()) setTimeout(()=> nextPhase('end'),900); else setTimeout(()=> nextPhase('night'),900);
}

/* ---------- ìŠ¹ë¦¬/ì¢…ë£Œ/ì ìˆ˜ ---------- */
function checkWin(){
  const alive = alivePlayers();
  const mafiaAlive = alive.filter(p=> teamOf(p)===TEAM.MAFIA).length;
  const townAlive = alive.filter(p=> teamOf(p)===TEAM.TOWN).length;
  if(mafiaAlive===0){ log('\nğŸ‰ íƒ€ìš´ ìŠ¹ë¦¬!'); applyScores('town'); return true; }
  if(mafiaAlive >= townAlive && mafiaAlive>0){ log('\nğŸ’€ ë§ˆí”¼ì•„ ìŠ¹ë¦¬!'); applyScores('mafia'); return true; }
  return false;
}
function applyScores(winner){
  game.players.forEach(p=>{ const team = teamOf(p); if(scores[p.id]===undefined) scores[p.id]=0; if(team===winner) scores[p.id]+=10; else scores[p.id]-=2; });
  renderScores(); saveScores();
}
function endPhase(){
  log('\n=== ê²Œì„ ì¢…ë£Œ â€” ì—­í•  ê³µê°œ ===');
  revealBox.style.display='block';
  let html=''; game.players.forEach(p=>{ html += `${p.id+1}ë²ˆ: ${p.role} (${p.alive?'ìƒì¡´':'ì‚¬ë§'})<br/>`; });
  revealList.innerHTML = html;
  inputSection.innerHTML = '<div class="warn">ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div><div style="text-align:center"><button id="restart">ë‹¤ì‹œ ì‹œì‘</button></div>';
  document.getElementById('restart').onclick = ()=> location.reload();
  renderPlayers();
}

// ì´ˆê¸° ì ìˆ˜ ë³´ì´ê¸°
renderScores();

</script></body>
</html>
